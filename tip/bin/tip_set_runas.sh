#!/bin/bash
# Update RunAs user and group 
# Usage: tip_set_runas.sh  [-washome $washome] [-user $user] -runas <user/group> 
#                          [-debug] 
#   Arguments:  
#           -washome|-wh $washome     WebSphere home directory  
#           -profile|-pr $profile     profile name    
#           -user $user               Execution userid used to execute commands . 
#                                     Default:  webinst, unless NCO, where default is netcool  
#           -logdir|waslogs $dir
#           -noprompts|-npr|-silent|-s
#           -debug
#
#   Description:
#
#   Examples:
#   1. WASHOME=/opt/IBM/Netcool/tip
#      cd /lfs/system/tools/tip/bin
#      sudo  ./tip_set_runas.sh -washome $WASHOME -runas <user/group> 
#      
#   2. cd /lfs/system/tools/tip/bin
#      wh=/opt/IBM/Netcool/tip;  user=""; group=""
#      sudo ./tip_set_runas.sh -wh $wh -user root -runas $user/$group -debug
# 
#   3. cd /lfs/system/tools/tip/bin
#      wh=/opt/IBM/Netcool/tip;  user="netcool"; group="itmusers"
#      sudo ./tip_set_runas.sh -wh $wh  -runas $user/$group 
#
#   Change History: 
#     09-01-2014 Initial. Show JVM msgs is default behavior.
#    

SCRIPT_VERSION=1.00a
SCRIPTNAME=$(basename $0)
HOST=`/bin/hostname -s`
VERSION=70  
#   TODO - RESET VERSION if JazzSM

PROFILE=TIPProfile
PROFILE_OVERRIDE=n
SERVER=server1
NODE=TIPNode
NODE_OVERRIDE=n
RC=0

# Defaults are based on a standard EI-WAS used by TAD but not TCR or NCR
WAS_HOME=/usr/WebSphere70/AppServer
WASHOME_OVERRIDE=n
WAS_PROFILE_HOME="${WAS_HOME}/profiles/${PROFILE}"

#WASLOGS=/logs/was$VERSION/TIPProfile
# Why would we need to change this?  It's a symlink 
WASLOGS=$WAS_PROFILE_HOME/logs

TIP_TOOLS=/lfs/system/tools/tip
TIPLIB=${TIP_TOOLS}/lib
SCRIPTS_HOME=/lfs/system/tools/was/scripts
WASLIB=/lfs/system/tools/was/lib
USER=webinst         # default userid under which WAS runs   <<<<<<<<<<<
USER_OVERRIDE=n

RUNAS_USER_GROUP=""  # $USER/$GROUP 
UPDATE_USER_GROUP=n

CONTINUE_PROMPTS=y
DEBUG=""

SHOW_JVM_MSGS=y               # Display messages generated by Jython scripts
BYPASS_RUG=n
DATE=$(date +"%Y%m%d%H%M")
JVM_OUTPUT_DIRECTIVE=""       #     >/dev/null"
#                             # Make displaying jvm msgs the default 

##
# Scan input arguments
##
scan_arguments() {
	  
    while [ "$1" != "" ]; do
       case "$1" in
        -washome|-wh) 
           shift 
           WAS_HOME=$1
           WASHOME_OVERRIDE=y
           ;; 
        -profile|-pr) 
           shift 
           PROFILE=$1
           PROFILE_OVERRIDE=y
           ;; 
        -node) 
           shift 
           NODE=$1
           NODE_OVERRIDE=y
           ;; 
        -user)    
           shift       
           USER=$1
           USER_OVERRIDE=y
           ;;
        -runasUserGroup|-ug|-runas|-rug)
           shift    
           RUNAS_USER_GROUP=$1 
           UPDATE_USER_GROUP=y
           ;;
       -logdir|waslogs)
           shift      
           WASLOGS=$1
           ;; 
       	-prompts|-pr)
           CONTINUE_PROMPTS=y
           ;;   
       	-noprompts|-npr|-silent|-s)
           CONTINUE_PROMPTS=n
           ;; 
        -debug)
           DEBUG=-debug   
           ;; 
        -jvm_msgs|-jm)
           SHOW_JVM_MSGS=y  
           ;; 
        *)
           ;;
      esac
      shift  
    done
}


# Issue prompt before contunue 
prompt_to_continue() {
  if [ $CONTINUE_PROMPTS == "y" ]; then
    echo "Hit any key to continue, or cancel(CNTL-c) to quit"  
    read -r choice 
  fi  
}

#################
# M A I N 
#################

echo "Executing $SCRIPTNAME version $SCRIPT_VERSION"

scan_arguments $*

#####################
# Examine the input 
#####################
#1. WAS home and profile home 
if [ $WASHOME_OVERRIDE == "y"  ]; then
    WAS_PROFILE_HOME="${WAS_HOME}/profiles/${PROFILE}"
    WASLOGS=$WAS_PROFILE_HOME/logs
fi
if [ $PROFILE_OVERRIDE == y ]; then
    WAS_PROFILE_HOME="${WAS_HOME}/profiles/${PROFILE}"
    WASLOGS=$WAS_PROFILE_HOME/logs
fi    
 
if [ ! -e $WAS_PROFILE_HOME ]; then
  echo "ERROR: WebSphere profile directory invalid: $WAS_PROFILE_HOME...terminating"
  exit 1
fi 
#2. wsadmin location  
WSADMIN=$WAS_PROFILE_HOME/bin/wsadmin.sh   
if [ ! -x $WSADMIN ]; then
    echo "Failed to locate $WAS_HOME/bin/wsadmin.sh ... exiting"
    exit 1
fi
#3. Support run as update 
#   No changes needed

#3. If NCO, the default user/group changes to "netcool/itmusers" 
was_home_is_nco=$(echo $WAS_HOME | tr '[:upper:]' '[:lower:]'   |  grep 'netcool' )
if [ $? -eq 0 ]; then 
	  if [ $USER_OVERRIDE == n ]; then
        USER=netcool
    fi    
fi
#4. Display Jython script messages
if [ "$DEBUG" != "" ]; then
    SHOW_JVM_MSGS="y"  
    echo "Displaying JVM output from Jython scripts"
fi            
#
# Confirm input before continuing 
#
  
  echo "*************** "
  echo "Confirm input:  "
  echo "*************** "
  echo "..WebSphere home(-washome): $WAS_HOME"
  echo "..WAS profile home:         $WAS_PROFILE_HOME"   
  echo "..WAS node:                 $NODE"   
  echo "..User(-user):              $USER" 
  if [ $UPDATE_USER_GROUP == y  ]; then
    echo "..Update runas(-runas):     $RUNAS_USER_GROUP"
  fi 
  echo "..Log directory(-logdir):   $WASLOGS"
  echo "..DEBUG:                    $DEBUG"
  echo "..Show JVM mgs:             $SHOW_JVM_MSGS" 
  echo  
  
prompt_to_continue

echo

#################################################
#
# Call wsadmin 
#
# Input:
#       RUNAS_USER_GROUP in format "user/group"  or "/" if neither supplied
#################################################

if [ $SHOW_JVM_MSGS == "y" ]; then
  JVM_OUTPUT_DIRECTIVE=""  
fi   
   
# 1. Update min/max heap sizes to values specified in $HEAP
#    Node is not used in -attr $HEAP call
if [  $UPDATE_USER_GROUP == y ]; then
   if [[ -e $WASLIB/server.py ]]; then
     echo "Updating runas user/group for $SERVER ...."
	   LOGGING="-tracefile $WASLOGS/wsadmin.${SERVER}-runas.traceout"  #-$DATE
	   CMD="$WSADMIN  $LOGGING -conntype NONE -f $WASLIB/server.py  -action modify -server ${SERVER} -attr runas:$RUNAS_USER_GROUP"
	   [ -n "$DEBUG" ] && echo "  RUNAS CMD=\"$CMD\""
	   SERVER_XML_LOC=$WAS_PROFILE_HOME/config/cells/TIPCell/nodes/$NODE/servers/server1/server.xml
     line=$(grep 'runAsUser'  $SERVER_XML_LOC)  #  > /dev/null
     if [ "$line" != "" ]; then
         [ -n "$DEBUG" ] && echo "  before runas command, server.xml line:"
         [ -n "$DEBUG" ] && echo "    $line"  
     else
         echo "   appears that no current runas exists"       
     fi      	 
 	   if [ $BYPASS_RUG == n ]; then
 	   	 echo "About to run command to update runas to: $RUNAS_USER_GROUP under user $USER"
 	   	 prompt_to_continue 
 	     su - $USER -c "$CMD" $JVM_OUTPUT_DIRECTIVE
 	     RC=$?
   	   if [ $RC -ne 0 ];  then
     	     echo "  ERROR: Failed to update user/group... exiting"
    	     exit 1
    	 else
    	   echo "Update completed successfully." 
    	   echo
    	   line=$(grep 'runAsUser'  $SERVER_XML_LOC) 
    	   if [ "$line" != "" ]; then
             [ -n "$DEBUG" ] && echo "  after runas command, server.xml line:"
             [ -n "$DEBUG" ] && echo "    $line" 
         else
             echo "   WARNMING: unexpected results - unable to locate runas line in $SERVER_XML_LOC"
         fi      
    	      
       fi
     else
       echo "  set runas user/group bypassed on request"
     fi     
   else
     echo "ERROR - script not located: $WASLIB/server.py "
   fi
else
    echo "No updates to user/group supplied"
 
fi
echo


# Issue restart message
echo
echo "Restart the WAS server1 for changes to take effect"

exit $RC
